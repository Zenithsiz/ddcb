---
alias:
  # External tools
  # prettier-ignore
  ld       : mips-linux-gnu-ld
  as       : mips-linux-gnu-as
  objcopy  : mips-linux-gnu-objcopy
  mkpsxiso : mkpsxiso
  cargo    : cargo
  sha256sum: sha256sum

  # Other tools
  generate_linker_script: tools/generate_linker_symbols_script.py
  preprocess_asm        : tools/preprocess_asm.py
  expand_asm            : tools/expand_asm.py
  generate_iso_deps     : tools/generate_iso_deps.py
  generate_compare_deps : tools/generate_compare_deps.py
  bspatch               : tools/bspatch.py

  # Cargo tools
  mkdrv        : $(tools_dir)/dcb-mkdrv
  mkdrv-deps   : $(tools_dir)/dcb-mkdrv-deps
  mkpak        : $(tools_dir)/dcb-mkpak
  mkpak-deps   : $(tools_dir)/dcb-mkpak-deps
  mkarc        : $(tools_dir)/dcb-mkarc
  mkarc-deps   : $(tools_dir)/dcb-mkarc-deps
  mkmsd        : $(tools_dir)/dcb-mkmsd
  mk-card-table: $(tools_dir)/dcb-mk-card-table
  mk-deck-table: $(tools_dir)/dcb-mk-deck-table
  mkpsexe      : $(tools_dir)/dcb-mkpsexe

  # Directories
  build_dir : build
  tools_dir : $(build_dir)/tools
  dcb_rs_dir: $(build_dir)/dcb-rs
  exe_dir   : $(build_dir)/exe
  asm_dir   : $(build_dir)/asm
  misc_dir  : $(build_dir)/misc
  drv_dir   : $(build_dir)/drv
  pak_dir   : $(build_dir)/pak
  arc_dir   : $(build_dir)/arc
  msd_dir   : $(build_dir)/msd
  dylib_dir : $(build_dir)/dylib

  # Files
  checksums            : checksums.sha256
  dcb_bin_xml          : dcb-iso.xml
  asm_src              : dcb-asm/dcb.s
  linker_script        : psx.ld
  license_iso          : license.dat
  license_psexe        : license-psexe.dat

  # Built files
  compare_deps         : $(build_dir)/compare.d
  dcb_bin              : $(build_dir)/dcb.bin
  dcb_bin_deps         : $(build_dir)/dcb.bin.d
  dcb_bin_cue          : $(build_dir)/dcb.cue
  linker_script_symbols: $(exe_dir)/symbols.ld
  dcb_elf              : $(exe_dir)/dcb.elf
  dcb_psexe            : $(exe_dir)/dcb.psexe
  mmm_buffer           : $(misc_dir)/MMM.DAT
  asm_expanded         : $(asm_dir)/dcb-expanded.s
  asm_processed        : $(asm_dir)/dcb-processed.s
  asm_obj              : $(asm_dir)/dcb.o
  asm_obj_deps         : $(asm_dir)/dcb.d
  dcb_rs_lib           : $(dcb_rs_dir)/libdcb.a
  dcb_rs_lib_deps      : $(dcb_rs_dir)/libdcb.d

# By default built the final binary
default:
  - $(dcb_bin)

rules:
  # Compare
  compare:
    deps: [$(checksums), deps_file: $(compare_deps)]
    exec:
      - [$(sha256sum), --check, --quiet, $(checksums)]

  # Compare dependencies
  compare-deps:
    out: [$(compare_deps)]
    deps: [$(checksums), $(generate_compare_deps)]
    static_deps: [dir_name: $(compare_deps)]
    exec:
      - [bash, -c, '$(generate_compare_deps) > $(compare_deps)']

  # Clean
  clean:
    exec:
      - [rm, -rf, $(build_dir)/]
      - [rm, -rf, dcb-rs/target/]
      - [rm, -rf, tools/target/]

  # Directories
  mkdir:
    alias:
      dir: $(build_dir)^(path)/
    out: [$(dir)]
    exec:
      - [mkdir, -p, $(dir)]

  # Rust library
  dcb_rs:
    alias:
      target_dir: target/mipsel-sony-psx/release
    out: [$(dcb_rs_lib), deps_file: $(dcb_rs_lib_deps)]
    static_deps: [dir_name: $(dcb_rs_lib)]
    exec_cwd: dcb-rs/
    exec:
      - - $(cargo)
        - build
        - --release
        - --package=dcb
        - -Z=unstable-options
        - --out-dir=../$(dcb_rs_dir)/
      - [cp, $(target_dir)/libdcb.d, ../$(dcb_rs_lib_deps)]
      - - sed
        - -i
        - -e
        - 's,dcb-rs/$(target_dir)/,$(dcb_rs_dir)/,g'
        - ../$(dcb_rs_lib_deps)

  # `dcb.bin`
  mkpsxiso:
    out: [$(dcb_bin), $(dcb_bin_cue)]
    deps: [$(dcb_bin_xml), $(license_iso), deps_file: $(dcb_bin_deps)]
    exec:
      - [$(mkpsxiso), $(dcb_bin_xml), -q, -y]

  # `dcb.bin` dependencies
  mkpsxiso-deps:
    out: [$(dcb_bin_deps)]
    deps: [$(dcb_bin_xml)]
    static_deps: [dir_name: $(dcb_bin_deps)]
    exec:
      - [bash, -c, '$(generate_iso_deps) > $(dcb_bin_deps)']

  # Cargo tools
  # TODO: Just use `$(tools_dir)/^(name)` when we can ensure it's not empty
  cargo-tool:
    alias:
      tool: $(tools_dir)/dcb-^(name)
    out: [$(tool), deps_file: $(tool).d]
    static_deps: [dir_name: $(tool)]
    exec_cwd: tools/
    exec:
      - - $(cargo)
        - build
        - --release
        - --package=dcb-^(name)
        - -Z=unstable-options
        - --out-dir=../$(tools_dir)
      - [cp, target/release/dcb-^(name).d, ../$(tool).d]
      - - sed
        - -i
        - -e
        - 's,tools/target/release/,$(tools_dir)/,g'
        - ../$(tool).d

  # `drv`
  mkdrv:
    alias:
      drv: $(drv_dir)/^(path).DRV
      drv_yaml: ^(path).DRV.yaml
      drv_patch: ^(path).DRV.bspatch
    out: [$(drv)]
    deps:
      - $(drv_yaml)
      - $(drv_patch)
      - $(mkdrv)
      - deps_file: $(drv).d
    static_deps: [dir_name: $(drv)]
    exec:
      - [$(mkdrv), $(drv_yaml), -o, $(drv)]
      - [$(bspatch), $(drv), $(drv), $(drv_patch)]

  # `drv` dependencies
  mkdrv-deps:
    alias:
      drv: $(drv_dir)/^(path).DRV
      drv_yaml: ^(path).DRV.yaml
    out: [$(drv).d]
    deps: [$(drv_yaml), $(mkdrv-deps)]
    static_deps: [dir_name: $(drv)]
    exec:
      - - $(mkdrv-deps)
        - $(drv_yaml)
        - -o
        - $(drv)
        - --deps-file
        - $(drv).d

  # `pak`
  mkpak:
    alias:
      pak: $(pak_dir)/^(path).PAK
      pak_yaml: ^(path).PAK.yaml
    out: [$(pak)]
    deps: [$(pak_yaml), $(mkpak), deps_file: $(pak).d]
    static_deps: [dir_name: $(pak)]
    exec:
      - [$(mkpak), $(pak_yaml), -o, $(pak)]

  # `pak` dependencies
  mkpak-deps:
    alias:
      pak: $(pak_dir)/^(path).PAK
      pak_yaml: ^(path).PAK.yaml
    out: [$(pak).d]
    deps: [$(pak_yaml), $(mkpak-deps)]
    static_deps: [dir_name: $(pak)]
    exec:
      - - $(mkpak-deps)
        - $(pak_yaml)
        - -o
        - $(pak)
        - --deps-file
        - $(pak).d

  # `arc`
  mkarc:
    alias:
      arc: $(arc_dir)/^(path).ARC
      arc_yaml: ^(path).ARC.yaml
    out: [$(arc)]
    deps: [$(arc_yaml), $(mkarc), deps_file: $(arc).d]
    static_deps: [dir_name: $(arc)]
    exec:
      - [$(mkarc), $(arc_yaml), -o, $(arc)]

  # `arc` dependencies
  mkarc-deps:
    alias:
      arc: $(arc_dir)/^(path).ARC
      arc_yaml: ^(path).ARC.yaml
    out: [$(arc).d]
    deps: [$(arc_yaml), $(mkarc-deps)]
    static_deps: [dir_name: $(arc)]
    exec:
      - - $(mkarc-deps)
        - $(arc_yaml)
        - -o
        - $(arc)
        - --deps-file
        - $(arc).d

  # `msd`
  mkmsd:
    alias:
      msd: $(msd_dir)/^(path).MSD
      msd_src: ^(path).MSD.s
      msd_patch: ^(path).MSD.bspatch
    out: [$(msd), deps_file: $(msd).d]
    deps:
      - $(msd_src)
      - $(msd_patch)
      - $(mkmsd)
    static_deps: [dir_name: $(msd)]
    exec:
      - [$(mkmsd), $(msd_src), -o, $(msd), --deps-file, $(msd).d]
      - [$(bspatch), $(msd), $(msd), $(msd_patch)]

  # Card table
  card_table:
    alias:
      cdd: $(misc_dir)/^(path).CDD
    out: [$(cdd)]
    deps:
      - ^(path).CDD.json
      - ^(path).CDD.bspatch
      - $(mk-card-table)
    static_deps: [dir_name: $(cdd)]
    exec:
      - [$(mk-card-table), ^(path).CDD.json, -o, $(cdd)]
      - [$(bspatch), $(cdd), $(cdd), ^(path).CDD.bspatch]

  # Deck table
  deck_table:
    alias:
      dek: $(misc_dir)/^(path).DEK
    out: [$(dek)]
    deps:
      - ^(path).DEK.json
      - ^(path).DEK.bspatch
      - $(mk-deck-table)
    static_deps: [dir_name: $(dek)]
    exec:
      - [$(mk-deck-table), ^(path).DEK.json, -o, $(dek)]
      - [$(bspatch), $(dek), $(dek), ^(path).DEK.bspatch]

  # Buffer
  mmm_buffer:
    out: [$(mmm_buffer)]
    static_deps: [dir_name: $(mmm_buffer)]
    exec:
      - [touch, $(mmm_buffer)]
      - [truncate, --size=24240128, $(mmm_buffer)]

  # Dylibs
  dylib:
    alias:
      dylib: $(dylib_dir)/^(name).BIN
      dylib_section: dylib.^(name)
      dcb_elf_copy: $(dcb_elf).^(name)
    out: [$(dylib)]
    deps: [$(dcb_elf)]
    static_deps: [dir_name: $(dylib)]

    # Note: We make a copy of the `elf` because it seems like `objcopy` messes with the
    #       modification date, which `make` uses to check dependencies
    exec:
      - [cp, $(dcb_elf), $(dcb_elf_copy)]
      - [$(objcopy), --dump-section, $(dylib_section)=$(dylib), $(dcb_elf_copy)]
      - [rm, $(dcb_elf_copy)]

  # Executable (ps-exe)
  exe_psexe:
    out: [$(dcb_psexe)]
    deps: [$(dcb_elf), $(license_psexe), $(mkpsexe)]
    static_deps: [dir_name: $(dcb_psexe)]
    exec:
      - - $(mkpsexe)
        - $(dcb_elf)
        - -o
        - $(dcb_psexe)
        - --license
        - $(license_psexe)

  # Executable (elf)
  exe_elf:
    out: [$(dcb_elf)]

    deps:
      - $(asm_obj)
      - $(dcb_rs_lib)
      - $(linker_script_symbols)
      - $(linker_script)
    static_deps: [dir_name: $(dcb_elf)]
    exec:
      - - $(ld)
        - $(asm_obj)
        - -o
        - $(dcb_elf)
        - --whole-archive
        - -EL
        - --nmagic
        - --script
        - $(linker_script)
        - --warn-section-align
        - --no-check-sections
        - -L$(dcb_rs_dir)/
        - -ldcb

  # Linker script symbol ordering
  linker_script_symbols:
    out: [$(linker_script_symbols)]
    deps:
      - symbols.yaml
      - section_addrs.yaml
      - $(generate_linker_script)
    static_deps: [dir_name: $(linker_script_symbols)]
    exec:
      - [$(generate_linker_script)]

  # Assembly object files
  asm_obj:
    out: [$(asm_obj), deps_file: $(asm_obj_deps)]
    deps: [$(asm_processed)]
    static_deps: [dir_name: $(asm_obj)]
    exec:
      - - $(as)
        - -MD
        - $(asm_obj_deps)
        - -o
        - $(asm_obj)
        - -EL
        - -mips1
        - -march=r3000
        - -msoft-float
        - -O2
        - $(asm_processed)

  # Processed asm
  process_asm:
    out: [$(asm_processed)]
    deps:
      - $(asm_expanded)
      - symbols.yaml
      - $(preprocess_asm)
    static_deps: [dir_name: $(asm_processed)]
    exec:
      - - $(preprocess_asm)
        - $(asm_expanded)
        - -o
        - $(asm_processed)
        - --replace-local-labels
        - --add-label-section

  # Expanded asm
  # TODO: Make `expand_asm` emit a dependency file
  expand_asm:
    out: [$(asm_expanded)]
    deps: [$(asm_src), $(expand_asm)]
    static_deps: [dir_name: $(asm_expanded)]
    exec:
      - - $(expand_asm)
        - $(asm_src)
        - -o
        - $(asm_expanded)
